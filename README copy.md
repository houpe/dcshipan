# 股票组合排行榜爬虫

专门用于获取和缓存股票组合排行榜数据的爬虫程序。

## 功能特性

- ✅ 获取5个排行榜数据（日榜、周榜、月榜、年榜、总榜）
- ✅ 使用DiskCache进行数据缓存
- ✅ 自动添加排名信息（从1开始）
- ✅ 定时执行（交易时间内每30秒执行一次）
- ✅ 显示进度条和统计信息
- ✅ 异步HTTP请求，支持重试机制
- ✅ 完整的错误处理和日志记录

## 数据源

程序从以下API获取数据：

- **日榜数据**: `rankType=10005`
- **周榜数据**: `rankType=10000` 
- **月榜数据**: `rankType=10001`
- **年榜数据**: `rankType=10003`
- **总榜数据**: `rankType=10004`

每个排行榜获取前50条记录。

## 数据格式

返回的JSON数据格式：

```json
{
  "result": "0",
  "message": "ok",
  "isList": "1",
  "listSize": "20",
  "data": [
    {
      "userid": "组合用户ID",
      "zjzh": "组合ID",
      "zhuheName": "组合名字",
      "concernCnt": "关注数",
      "uidNick": "用户昵称",
      "label1": "标签1",
      "label2": "标签2",
      "label3": "标签3",
      "rateTitle": "收益类型",
      "rateForApp": "收益率",
      "zuheflag": "1",
      "rank": 1,
      "rank_type": "daily",
      "rank_name": "日榜"
    }
  ],
  "rankid": "0"
}
```

## 安装依赖

```bash
pip install -r requirements.txt
```

## 使用方法

### 1. 运行主程序

```bash
python rank_crawler.py
```

程序会：
1. 启动时执行首次数据获取
2. 显示数据摘要
3. 启动定时任务调度器
4. 在交易时间内每30秒自动更新数据

### 2. 运行测试

```bash
python test_crawler.py
```

测试包括：
- 交易时间判断
- 缓存操作
- API连接性
- 完整数据获取

## 交易时间

程序只在交易时间内执行数据更新：
- **交易日**: 周一至周五
- **交易时间**: 
  - 上午：9:15 - 11:30
  - 下午：13:00 - 15:00
- **更新频率**: 每30秒

## 缓存机制

- 使用DiskCache进行数据持久化
- 缓存目录：`data/cache/rank_cache`
- 每次更新都会保存带时间戳的数据
- 同时维护最新数据的快速访问

### 缓存数据结构

```python
{
    "timestamp": "20231201_143022",
    "date": "2023-12-01",
    "update_time": "2023-12-01T14:30:22.123456",
    "total_records": 250,
    "data": {
        "daily": { ... },
        "weekly": { ... },
        "monthly": { ... },
        "yearly": { ... },
        "total": { ... }
    }
}
```

## 日志记录

程序会记录详细的运行日志：
- 数据获取进度
- 成功/失败状态
- 错误信息
- 性能统计

## 进度显示

程序使用tqdm显示获取进度：
```
获取排行榜数据: 100%|██████████| 5/5 [00:02<00:00, 2.31个/s] 已完成: 5/5, 耗时: 2.15s
```

## 错误处理

- HTTP请求失败自动重试（最多3次）
- 网络超时处理
- JSON解析错误处理
- 缓存操作异常处理
- 优雅的程序退出

## 程序结构

```
new/
├── rank_crawler.py      # 主爬虫程序
├── test_crawler.py      # 测试脚本
├── requirements.txt     # 依赖包列表
├── README.md           # 说明文档
└── data/               # 数据目录（自动创建）
    └── cache/          # 缓存目录
        └── rank_cache/ # DiskCache数据
```

## 注意事项

1. 确保网络连接正常
2. 程序需要写入权限创建缓存目录
3. 建议在服务器上运行以保证连续性
4. 可以通过Ctrl+C优雅停止程序
5. 年榜和总榜数据只取前50条记录

## 扩展功能

如需扩展功能，可以：
1. 修改`rank_types`配置添加新的排行榜类型
2. 调整`recCnt`参数改变获取的记录数量
3. 修改定时任务频率
4. 添加数据分析和处理逻辑
5. 集成Web界面或API服务